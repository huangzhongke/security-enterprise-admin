"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var l=t[r];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(e,l.key,l)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}var Rule=function(){function t(e){_classCallCheck(this,t),Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.max,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}return _createClass(t,[{key:"message",get:function(){return _tools.UtilTools.getFuncText(this.$options.message)}}]),t}(),_default={methods:{_fullValidate:function(e,t){return this.beginValidate(e,t,!0)},_validate:function(e,t){return this.beginValidate(e,t)},handleValidError:function(e){var t=this;!1===this.validOpts.autoPos?this.emitEvent("valid-error",e):this.handleActived(e,{type:"valid-error",trigger:"call"}).then(function(){return setTimeout(function(){return t.showValidTooltip(e)},10)})},beginValidate:function(e,u,i){var c=this,n={},d=!0,t=this.editRules,f=this.afterFullData,h=this.treeConfig,r=this.treeOpts,l=f;e&&(_xeUtils.default.isFunction(e)?u=e:l=_xeUtils.default.isArray(e)?e:[e]);var a=[];if(this.lastCallTime=Date.now(),this.validRuleErr=!1,this.clearValidate(),t){var o=this.getColumns(),s=function(l){if(!c.validRuleErr){var e=[];o.forEach(function(r){!c.validRuleErr&&_xeUtils.default.has(t,r.property)&&e.push(c.validCellRules("all",l,r).catch(function(e){var t={rule:e.rule,rules:e.rules,rowIndex:c.getRowIndex(l),row:l,columnIndex:c.getColumnIndex(r),column:r,$table:c};if(!i)return c.validRuleErr=!0,Promise.reject(t);n[r.property]||(n[r.property]=[]),n[r.property].push(t)}))}),a.push(Promise.all(e))}};return h?_xeUtils.default.eachTree(l,s,r):l.forEach(s),Promise.all(a).then(function(){var e=Object.keys(n);if(e.length)return Promise.reject(n[e[0]][0]);u&&("obsolete"===_conf.default.validArgs?u(d):u())}).catch(function(o){var s=i?n:_defineProperty({},o.column.property,o);return new Promise(function(e,t){var r=function(){d=!1,u?("obsolete"===_conf.default.validArgs?u(d,s):u(s),e()):t(s)},l=function(){o.cell=_tools.DomTools.getCell(c,o),_tools.DomTools.toView(o.cell),c.handleValidError(o),r()},i=o.row,n=f.indexOf(i),a=0<n?f[n-1]:i;!1===c.validOpts.autoPos?r():h?c.scrollToTreeRow(a).then(l):c.scrollToRow(a).then(l)})})}return u&&("obsolete"===_conf.default.validArgs?u(d):u()),Promise.resolve()},hasCellRules:function(t,e,r){var l=this.editRules,i=r.property;if(i&&l){var n=_xeUtils.default.get(l,i);return n&&_xeUtils.default.find(n,function(e){return"all"===t||!e.trigger||t===e.trigger})}return!1},validCellRules:function(i,n,a,e){var o=this,t=this.editRules,r=a.property,s=[],u=[];if(r&&t){var c=_xeUtils.default.get(t,r);if(c){var d=_xeUtils.default.isUndefined(e)?_xeUtils.default.get(n,r):e;c.forEach(function(r){if("all"===i||!r.trigger||i===r.trigger)if(_xeUtils.default.isFunction(r.validator)){var e;(e="obsolete"===_conf.default.validArgs?new Promise(function(t){r.validator(r,d,function(e){_xeUtils.default.isError(e)&&(o.validRuleErr=!0,s.push(new Rule({type:"custom",trigger:r.trigger,message:e.message,rule:new Rule(r)}))),t()},{rule:r,rules:c,row:n,column:a,rowIndex:o.getRowIndex(n),columnIndex:o.getColumnIndex(a),$table:o})}):r.validator({cellValue:d,rule:r,rules:c,row:n,rowIndex:o.getRowIndex(n),column:a,columnIndex:o.getColumnIndex(a),$table:o}))&&(_xeUtils.default.isError(e)?(o.validRuleErr=!0,s.push(new Rule({type:"custom",trigger:r.trigger,message:e.message,rule:new Rule(r)}))):e.catch&&u.push(e.catch(function(e){o.validRuleErr=!0,s.push(new Rule({type:"custom",trigger:r.trigger,message:e?e.message:r.message,rule:new Rule(r)}))})))}else{var t="number"===r.type,l=t?_xeUtils.default.toNumber(d):_xeUtils.default.getSize(d);null==d||""===d?r.required&&(o.validRuleErr=!0,s.push(new Rule(r))):(t&&isNaN(d)||!isNaN(r.min)&&l<parseFloat(r.min)||!isNaN(r.max)&&l>parseFloat(r.max)||r.pattern&&!(r.pattern.test?r.pattern:new RegExp(r.pattern)).test(d))&&(o.validRuleErr=!0,s.push(new Rule(r)))}})}}return Promise.all(u).then(function(){if(s.length){var e={rules:s,rule:s[0]};return Promise.reject(e)}})},_clearValidate:function(){var e=this.$refs.validTip;return Object.assign(this.validStore,{visible:!1,row:null,column:null,content:"",rule:null}),e&&e.visible&&e.close(),this.$nextTick()},triggerValidate:function(l){var i=this,e=this.editConfig,t=this.editStore,r=this.editRules,n=this.validStore,a=t.actived;if(a.row&&r){var o=a.args,s=o.row,u=o.column,c=o.cell;if(this.hasCellRules(l,s,u))return this.validCellRules(l,s,u).then(function(){"row"===e.mode&&n.visible&&n.row===s&&n.column===u&&i.clearValidate()}).catch(function(e){var t=e.rule;if(t.trigger&&l!==t.trigger)return Promise.resolve();var r={rule:t,row:s,column:u,cell:c};return i.showValidTooltip(r),Promise.reject(r)})}return Promise.resolve()},showValidTooltip:function(e){var t=this,r=this.$refs,l=this.height,i=this.tableData,n=this.validOpts,a=e.rule,o=e.row,s=e.column,u=e.cell,c=r.validTip,d=a.message;this.$nextTick(function(){Object.assign(t.validStore,{row:o,column:s,rule:a,content:d,visible:!0}),c&&("tooltip"===n.message||"default"===n.message&&!l&&i.length<2)&&c.toVisible(u,d),t.emitEvent("valid-error",e)})}}};exports.default=_default;