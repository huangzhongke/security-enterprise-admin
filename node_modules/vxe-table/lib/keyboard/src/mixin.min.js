"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var browse=_tools.DomTools.browse;function getTargetOffset(e,o){var t=0,l=0,s=!browse.firefox&&_tools.DomTools.hasClass(e,"vxe-checkbox--label");if(s){var n=getComputedStyle(e);t-=_xeUtils.default.toNumber(n.paddingTop),l-=_xeUtils.default.toNumber(n.paddingLeft)}for(;e&&e!==o;)if(t+=e.offsetTop,l+=e.offsetLeft,e=e.offsetParent,s){var i=getComputedStyle(e);t-=_xeUtils.default.toNumber(i.paddingTop),l-=_xeUtils.default.toNumber(i.paddingLeft)}return{offsetTop:t,offsetLeft:l}}function getCheckboxRangeResult(e,o,t,l){var s=0,n=[],i=0<l,c=0<l?l:Math.abs(l)+t.offsetHeight,r=e.afterFullData,d=e.scrollYStore;if(e.scrollYLoad){var a=e._getRowIndex(o.row);n=i?r.slice(a,a+Math.ceil(c/d.rowHeight)):r.slice(a-Math.floor(c/d.rowHeight)+1,a+1)}else for(var h=i?"next":"previous";t&&s<c;)n.push(e.getRowNode(t).item),s+=t.offsetHeight,t=t["".concat(h,"ElementSibling")];return n}var _default={methods:{moveTabSelected:function(e,o,t){var l,s,n,i,c=this,r=this.afterFullData,d=this.visibleColumn,a=this.editConfig,h=this.editOpts,u=this.isSeqColumn,f=Object.assign({},e),m=r.indexOf(f.row),g=d.indexOf(f.column);if(t.preventDefault(),o){for(var x=g-1;0<=x;x--)if(!u(d[x])){n=d[i=x];break}if(!n&&0<m){l=r[s=m-1];for(var p=d.length-1;0<=p;p--)if(!u(d[p])){n=d[i=p];break}}}else{for(var C=g+1;C<d.length;C++)if(!u(d[C])){n=d[i=C];break}if(!n&&m<r.length-1){l=r[s=m+1];for(var v=0;v<d.length;v++)if(!u(d[v])){n=d[i=v];break}}}n&&(l?(f.rowIndex=s,f.row=l):f.rowIndex=m,f.columnIndex=i,f.column=n,f.cell=_tools.DomTools.getCell(this,f),a&&("click"!==h.trigger&&"dblclick"!==h.trigger||("row"===h.mode?this.handleActived(f,t):this.scrollToRow(f.row,f.column).then(function(){return c.handleSelected(f,t)}))))},moveCurrentRow:function(e,o,t){var l,s=this,n=this.currentRow,i=this.treeConfig,c=this.treeOpts,r=this.afterFullData;if(t.preventDefault(),i){var d=_xeUtils.default.findTree(r,function(e){return e===n},c),a=d.index,h=d.items;e&&0<a?l=h[a-1]:o&&a<h.length-1&&(l=h[a+1])}else{var u=this._getRowIndex(n);e&&0<u?l=r[u-1]:o&&u<r.length-1&&(l=r[u+1])}if(l){var f={$table:this,row:l};this.scrollToRow(l).then(function(){return s.triggerCurrentRowEvent(t,f)})}},moveSelected:function(e,o,t,l,s,n){var i=this,c=this.afterFullData,r=this.visibleColumn,d=this.isSeqColumn,a=Object.assign({},e),h=this._getRowIndex(a.row),u=this._getColumnIndex(a.column);if(n.preventDefault(),t&&0<h)a.rowIndex=h-1,a.row=c[a.rowIndex];else if(s&&h<c.length-1)a.rowIndex=h+1,a.row=c[a.rowIndex];else if(o&&u){for(var f=u-1;0<=f;f--)if(!d(r[f])){a.columnIndex=f,a.column=r[f];break}}else if(l)for(var m=u+1;m<r.length;m++)if(!d(r[m])){a.columnIndex=m,a.column=r[m];break}this.scrollToRow(a.row,a.column).then(function(){a.cell=_tools.DomTools.getCell(i,a),i.handleSelected(a,n)})},triggerHeaderCellMousedownEvent:function(e,o){var r=this.$el,t=this.tableData,l=this.mouseConfig,s=this.mouseOpts,n=this.elemStore,d=this.handleChecked,a=this.handleHeaderChecked,i=e.button,c=o.column,h=e.currentTarget,u=0===i,f="seq"===c.type||"index"===c.type,m=l&&(s.range||s.checked);if(o.cell=h,l&&m){var g=n["main-header-list"].children,x=n["main-body-list"].children;if(f)this.handleAllChecked(e);else{this.clearSelected(e),this.clearHeaderChecked(),this.clearIndexChecked();var p=x[0].querySelector(".".concat(c.id));if(u){var C=document.onmousemove,v=document.onmouseup,_=_xeUtils.default.throttle(function(e){var o=_tools.DomTools.getEventTargetNode(e,r,"vxe-header--column"),t=o.flag,l=o.targetElem;if(!t){var s=_tools.DomTools.getEventTargetNode(e,r,"vxe-body--column");t=s.flag,l=s.targetElem}if(t&&!_tools.DomTools.hasClass(l,"col--seq")){var n=[].indexOf.call(l.parentNode.children,l),i=x[x.length-1].children[n],c=g[0].children[n];a(_tools.DomTools.getRowNodes(g,_tools.DomTools.getCellNodeIndex(c),_tools.DomTools.getCellNodeIndex(h))),d(_tools.DomTools.getRowNodes(x,_tools.DomTools.getCellNodeIndex(p),_tools.DomTools.getCellNodeIndex(i)))}},80,{leading:!0,trailing:!0});_tools.DomTools.addClass(r,"c--checked"),document.onmousemove=function(e){e.preventDefault(),e.stopPropagation(),_(e)},document.onmouseup=function(){_tools.DomTools.removeClass(r,"c--checked"),document.onmousemove=C,document.onmouseup=v}}if(a([[h]]),x.length){var T=x[x.length-1].querySelector(".".concat(c.id)),y=x[0],b=x[x.length-1],D=y.querySelector(".col--seq");o.rowIndex=0,o.row=t[0],o.cell=_tools.DomTools.getCell(this,o),this.handleSelected(o,e),this.handleIndexChecked(_tools.DomTools.getRowNodes(x,_tools.DomTools.getCellNodeIndex(D),_tools.DomTools.getCellNodeIndex(b.querySelector(".col--seq")))),this.handleChecked(_tools.DomTools.getRowNodes(x,_tools.DomTools.getCellNodeIndex(p),_tools.DomTools.getCellNodeIndex(T)))}}}this.focus(),this.closeMenu()},triggerCellMousedownEvent:function(e,o){var r=this.$el,t=this.visibleColumn,l=this.editStore,s=this.editConfig,n=this.editOpts,i=this.handleSelected,c=this.checkboxOpts,d=this.mouseConfig,a=this.mouseOpts,h=this.handleChecked,u=this.handleIndexChecked,f=this.handleHeaderChecked,m=this.elemStore,g=l.checked,x=o.column,p=e.button,C=e.currentTarget,v=0===p,_="seq"===x.type||"index"===x.type,T=d&&(a.range||a.checked);if(o.cell=C,T){this.clearHeaderChecked(),this.clearIndexChecked();var y=m["main-body-list"].children,b=m["main-header-list"].children,D=C.parentNode.lastElementChild,w=C.parentNode.firstElementChild;if(v){var k=document.onmousemove,N=document.onmouseup,I=_tools.DomTools.getCellNodeIndex(C),S=[].indexOf.call(C.parentNode.children,C),R=b[0].children[S],E=_xeUtils.default.throttle(function(e){var o=_tools.DomTools.getEventTargetNode(e,r,"vxe-body--column"),t=o.flag,l=o.targetElem;if(t)if(_){var s=l.parentNode.firstElementChild;h(_tools.DomTools.getRowNodes(y,_tools.DomTools.getCellNodeIndex(s.nextElementSibling),_tools.DomTools.getCellNodeIndex(D))),u(_tools.DomTools.getRowNodes(y,_tools.DomTools.getCellNodeIndex(s),_tools.DomTools.getCellNodeIndex(C)))}else if(!_tools.DomTools.hasClass(l,"col--seq")){var n=l.parentNode.firstElementChild,i=[].indexOf.call(l.parentNode.children,l),c=b[0].children[i];f(_tools.DomTools.getRowNodes(b,_tools.DomTools.getCellNodeIndex(c),_tools.DomTools.getCellNodeIndex(R))),u(_tools.DomTools.getRowNodes(y,_tools.DomTools.getCellNodeIndex(n),_tools.DomTools.getCellNodeIndex(w))),h(_tools.DomTools.getRowNodes(y,I,_tools.DomTools.getCellNodeIndex(l)))}},80,{leading:!0,trailing:!0});document.onmousemove=function(e){e.preventDefault(),e.stopPropagation(),E(e)},document.onmouseup=function(){document.onmousemove=k,document.onmouseup=N}}if(_){var O=C.parentNode.firstElementChild;o.columnIndex++,o.column=t[o.columnIndex],o.cell=C.nextElementSibling,i(o,e),h(_tools.DomTools.getRowNodes(y,_tools.DomTools.getCellNodeIndex(O.nextElementSibling),_tools.DomTools.getCellNodeIndex(D))),f([b[0].querySelectorAll(".vxe-header--column:not(.col--seq)")]),u(_tools.DomTools.getRowNodes(y,_tools.DomTools.getCellNodeIndex(O),_tools.DomTools.getCellNodeIndex(C)))}else if(v){var q=C.parentNode.firstElementChild;i(o,e),f([[b[0].querySelector(".".concat(x.id))]]),u([[q]])}else a.selected&&(g.rowNodes&&g.rowNodes.some(function(e){return-1<e.indexOf(C)})||i(o,e))}else c.range&&v&&this.handleCheckboxRangeEvent(e,o),a.selected&&(_||s&&"cell"!==n.mode||i(o,e));this.focus(),this.closeFilter(),this.closeMenu()},getCheckboxRangeResult:function(e,o){for(var t=0,l=[],s=0<o?"next":"previous",n=0<o?o:Math.abs(o)+e.offsetHeight;e&&t<n;)l.push(this.getRowNode(e).item),t+=e.offsetHeight,e=e["".concat(s,"ElementSibling")];return l},handleCheckboxRangeEvent:function(e,a){var h=this,o=a.column,t=a.cell;if(-1<["checkbox","selection"].indexOf(o.type)){var l=this.elemStore,u=e.clientX,f=e.clientY,m=l["".concat(o.fixed||"main","-body-wrapper")]||l["main-body-wrapper"],g=l["".concat(o.fixed||"main","-body-checkRange")]||l["main-body-checkRange"],s=document.onmousemove,n=document.onmouseup,x=t.parentNode,p=this.getCheckboxRecords(),C=[],i=getTargetOffset(e.target,m),v=i.offsetTop+e.offsetY,_=i.offsetLeft+e.offsetX,T=m.scrollTop,c=x.offsetHeight,r=null,d=!1,y=1,b=function(e){var o=e.clientX,t=e.clientY,l=o-u,s=t-f+(m.scrollTop-T),n=Math.abs(s),i=Math.abs(l),c=v,r=_;s<1?(c+=s)<1&&(c=1,n=v):n=Math.min(n,m.scrollHeight-v-1),l<1?(r+=l,_<i&&(r=1,i=_)):i=Math.min(i,m.clientWidth-_-1),g.style.height="".concat(n,"px"),g.style.width="".concat(i,"px"),g.style.left="".concat(r,"px"),g.style.top="".concat(c,"px"),g.style.display="block";var d=getCheckboxRangeResult(h,a,x,s<1?-n:n);10<n&&d.length!==C.length&&(C=d,e.ctrlKey?d.forEach(function(e){h.handleSelectRow({row:e},-1===p.indexOf(e))}):(h.setAllCheckboxRow(!1),h.setCheckboxRow(d,!0)))},D=function(){clearTimeout(r),r=null},w=function n(i){D(),r=setTimeout(function(){if(r){var e=m.scrollLeft,o=m.scrollTop,t=m.clientHeight,l=m.scrollHeight,s=Math.ceil(50*y/c);d?o+t<l?(h.scrollTo(e,o+s),n(i),b(i)):D():o?(h.scrollTo(e,o-s),n(i),b(i)):D()}},50)};document.onmousemove=function(e){e.preventDefault(),e.stopPropagation();var o=e.clientY,t=_tools.DomTools.getAbsolutePos(m).boundingTop;o<t?(d=!1,y=t-o,r||w(e)):o>t+m.clientHeight?(d=!0,y=o-t-m.clientHeight,r||w(e)):r&&D(),b(e)},document.onmouseup=function(){D(),g.removeAttribute("style"),document.onmousemove=s,document.onmouseup=n}}},_clearChecked:function(){var e=this.$refs,o=this.editStore,t=this.mouseConfig,l=this.mouseOpts,s=o.checked;if(t&&(l.range||l.checked)){var n=e.tableBody;s.rows=[],s.columns=[],s.tRows=[],s.tColumns=[],n.$refs.checkBorders.style.display="none",_xeUtils.default.arrayEach(n.$el.querySelectorAll(".col--checked"),function(e){return _tools.DomTools.removeClass(e,"col--checked")})}return this.$nextTick()},_getMouseSelecteds:function(){return _tools.UtilTools.warn("vxe.error.delFunc",["getMouseSelecteds","getSelectedCell"]),this.getSelectedCell()},_getMouseCheckeds:function(){return this.getSelectedRanges()},_getSelectedCell:function(){var e=this.editStore.selected,o=e.args,t=e.column;return o&&t?Object.assign({},o):null},_getSelectedRanges:function(){var o=this,e=this.editStore.checked.rowNodes,t=void 0===e?[]:e,l=[],s=[];return t&&t.length&&(s=t.map(function(e){return o.getRowNode(e[0].parentNode).item}),l=t[0].map(function(e){return o.getColumnNode(e).item})),{columns:l,rows:s,rowNodes:t}},handleChecked:function(e){var o=this.editStore.checked;this.clearChecked();var s=-2,n=-2,i=0,c=0;_xeUtils.default.arrayEach(e,function(e,o){var l=0===o;_xeUtils.default.arrayEach(e,function(e,o){var t=0===o;t&&l&&(i=e.offsetTop,c=e.offsetLeft),l&&(s+=e.offsetWidth),t&&(n+=e.offsetHeight),_tools.DomTools.addClass(e,"col--checked")})});var t=this.$refs.tableBody.$refs,l=t.checkBorders,r=t.checkTop,d=t.checkRight,a=t.checkBottom,h=t.checkLeft;l.style.display="block",Object.assign(r.style,{top:"".concat(i,"px"),left:"".concat(c,"px"),width:"".concat(s,"px")}),Object.assign(d.style,{top:"".concat(i,"px"),left:"".concat(c+s,"px"),height:"".concat(n,"px")}),Object.assign(a.style,{top:"".concat(i+n,"px"),left:"".concat(c,"px"),width:"".concat(s,"px")}),Object.assign(h.style,{top:"".concat(i,"px"),left:"".concat(c,"px"),height:"".concat(n,"px")}),o.rowNodes=e},handleAllChecked:function(e){var o=this.tableData,t=this.visibleColumn,l=this.mouseConfig,s=this.mouseOpts,n=this.elemStore;if(l&&(s.range||s.checked)){e.preventDefault();var i=n["main-header-list"],c=i.children,r=n["main-body-list"].children,d=_xeUtils.default.find(t,function(e){return"seq"===e.type||"index"===e.type})||t[0],a=i.querySelector(".".concat(d.id)),h=r[0],u=r[r.length-1],f=h.querySelector(".".concat(d.id)),m={$table:this,rowIndex:0,row:o[0],column:_xeUtils.default.find(t,function(e){return e.property})};m.columnIndex=this.getColumnIndex(m.column),m.cell=_tools.DomTools.getCell(this,m),this.handleSelected(m,e),this.handleHeaderChecked(_tools.DomTools.getRowNodes(c,_tools.DomTools.getCellNodeIndex(a.nextElementSibling),_tools.DomTools.getCellNodeIndex(a.parentNode.lastElementChild))),this.handleIndexChecked(_tools.DomTools.getRowNodes(r,_tools.DomTools.getCellNodeIndex(f),_tools.DomTools.getCellNodeIndex(u.querySelector(".".concat(d.id))))),this.handleChecked(_tools.DomTools.getRowNodes(r,_tools.DomTools.getCellNodeIndex(f.nextElementSibling),_tools.DomTools.getCellNodeIndex(u.lastElementChild)))}},handleIndexChecked:function(e){var o=this.editStore.indexs;this.clearIndexChecked(),_xeUtils.default.arrayEach(e,function(e){_xeUtils.default.arrayEach(e,function(e){_tools.DomTools.addClass(e,"col--seq-checked")})}),o.rowNodes=e},_clearIndexChecked:function(){var e=this.elemStore["main-body-list"];return _xeUtils.default.arrayEach(e.querySelectorAll(".col--seq-checked"),function(e){return _tools.DomTools.removeClass(e,"col--seq-checked")}),this.$nextTick()},handleHeaderChecked:function(e){var o=this.editStore.titles;this.clearHeaderChecked(),_xeUtils.default.arrayEach(e,function(e){_xeUtils.default.arrayEach(e,function(e){_tools.DomTools.addClass(e,"col--title-checked")})}),o.rowNodes=e},_clearHeaderChecked:function(){var e=this.elemStore["main-header-list"];return e&&_xeUtils.default.arrayEach(e.querySelectorAll(".col--title-checked"),function(e){return _tools.DomTools.removeClass(e,"col--title-checked")}),this.$nextTick()},_clearCopyed:function(){var e=this.$refs,o=this.editStore,t=this.keyboardConfig,l=o.copyed;if(t&&t.isCut){var s=e.tableBody,n=e.tableBody.$refs.copyBorders;l.cut=!1,l.rows=[],l.columns=[],n.style.display="none",_xeUtils.default.arrayEach(s.$el.querySelectorAll(".col--copyed"),function(e){return _tools.DomTools.removeClass(e,"col--copyed")})}return this.$nextTick()},handleCopyed:function(e){var o=this.tableData,t=this.tableColumn,l=this.editStore,s=l.copyed,n=l.checked.rowNodes;this.clearCopyed();var i=-3,c=-3,r=0,d=0,a=[],h=[];if(n.length){var u=n[0],f=_tools.DomTools.getCellNodeIndex(u[0]),m=f.rowIndex,g=f.columnIndex;a=t.slice(g,g+u.length),h=o.slice(m,m+n.length)}_xeUtils.default.arrayEach(n,function(e,o){var l=0===o;_xeUtils.default.arrayEach(e,function(e,o){var t=0===o;t&&l&&(r=e.offsetTop,d=e.offsetLeft),l&&(i+=e.offsetWidth),t&&(c+=e.offsetHeight),_tools.DomTools.addClass(e,"col--copyed")})});var x=this.$refs.tableBody.$refs,p=x.copyBorders,C=x.copyTop,v=x.copyRight,_=x.copyBottom,T=x.copyLeft;p.style.display="block",Object.assign(C.style,{top:"".concat(r,"px"),left:"".concat(d,"px"),width:"".concat(i,"px")}),Object.assign(v.style,{top:"".concat(r,"px"),left:"".concat(d+i,"px"),height:"".concat(c,"px")}),Object.assign(_.style,{top:"".concat(r+c,"px"),left:"".concat(d,"px"),width:"".concat(i,"px")}),Object.assign(T.style,{top:"".concat(r,"px"),left:"".concat(d,"px"),height:"".concat(c,"px")}),s.cut=e,s.rows=h,s.columns=a,s.rowNodes=n},handlePaste:function(){var o=this.tableData,n=this.visibleColumn,e=this.editStore,t=this.elemStore,l=e.copyed,s=e.selected,i=l.cut,c=l.rows,r=l.columns;if(c.length&&r.length&&s.row&&s.column){var d=s.args,a=d.rowIndex,h=d.columnIndex;_xeUtils.default.arrayEach(c,function(l,e){var s=o[a+e];s&&_xeUtils.default.arrayEach(r,function(e,o){var t=n[h+o];t&&_tools.UtilTools.setCellValue(s,t,_tools.UtilTools.getCellValue(l,e)),i&&_tools.UtilTools.setCellValue(l,e,null)})}),i&&this.clearCopyed();var u=t["main-body-list"].children,f=s.args.cell,m=f.parentNode,g=_xeUtils.default.arrayIndexOf(m.children,f),x=u[_xeUtils.default.arrayIndexOf(u,m)+c.length-1].children[g+r.length-1];this.handleChecked(_tools.DomTools.getRowNodes(u,_tools.DomTools.getCellNodeIndex(f),_tools.DomTools.getCellNodeIndex(x)))}}}};exports.default=_default;