"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}var _default={name:"VxeList",props:{data:Array,height:[Number,String],maxHeight:[Number,String],loading:Boolean,autoResize:Boolean,syncResize:[Boolean,String,Number],scrollY:Object},data:function(){return{scrollYLoad:!1,bodyHeight:0,topSpaceHeight:0,items:[]}},computed:{sYOpts:function(){return Object.assign({},_conf.default.list.scrollY,this.scrollY)},styles:function(){var t=this.height,e=this.maxHeight,i={};return t?i.height=isNaN(t)?t:"".concat(t,"px"):e&&(i.height="auto",i.maxHeight=isNaN(e)?e:"".concat(e,"px")),i}},watch:{data:function(t){this.loadData(t)},syncResize:function(t){var e=this;t&&(this.recalculate(),this.$nextTick(function(){return setTimeout(function(){return e.recalculate()})}))}},created:function(){Object.assign(this,{fullData:[],lastScrollLeft:0,lastScrollTop:0,scrollYStore:{startIndex:0,visibleIndex:0,renderSize:0}}),this.loadData(this.data),_tools.GlobalEvent.on(this,"resize",this.handleGlobalResizeEvent)},mounted:function(){var t=this;if(this.autoResize){var e=new _tools.ResizeEvent(function(){return t.recalculate()});e.observe(this.$el),this.$resize=e}},beforeDestroy:function(){this.$resize&&this.$resize.disconnect()},destroyed:function(){_tools.GlobalEvent.off(this,"resize")},render:function(t){var e=this.$scopedSlots,i=this.styles,s=this.bodyHeight,l=this.topSpaceHeight,r=this.items,a=this.loading;return[t("div",{class:["vxe-list",{"is--loading":a}]},[t("div",{ref:"virtualWrapper",class:"vxe-list--virtual-wrapper",style:i,on:{scroll:this.scrollEvent}},[t("div",{ref:"ySpace",class:"vxe-list--y-space",style:{height:s?"".concat(s,"px"):""}}),t("div",{ref:"body",class:"vxe-list--body",style:{marginTop:l?"".concat(l,"px"):""}},e.default?e.default.call(this,{items:r,$list:this},t):[])]),t("div",{class:["vxe-list--loading vxe-loading",{"is--visible":a}]},[t("div",{class:"vxe-loading--spinner"})])])]},methods:{getParentElem:function(){return this.$el.parentNode},loadData:function(t){var e=this,i=this.sYOpts,s=this.scrollYStore,l=t||[];return s.startIndex=0,s.visibleIndex=0,this.fullData=l,this.scrollYLoad=-1<i.gt&&l.length>i.gt,this.handleData(),this.computeScrollLoad().then(function(){e.refreshScroll()})},reloadData:function(t){return this.clearScroll(),this.loadData(t)},handleData:function(){var t=this.fullData,e=this.scrollYLoad,i=this.scrollYStore;return this.items=e?t.slice(i.startIndex,Math.max(i.startIndex+i.renderSize,1)):t.slice(0),this.$nextTick()},recalculate:function(){var t=this.$el;return t.clientWidth&&t.clientHeight?this.computeScrollLoad():Promise.resolve()},clearScroll:function(){var t=this.$refs.virtualWrapper;t&&(t.scrollTop=0)},refreshScroll:function(){var t=this,e=this.lastScrollLeft,i=this.lastScrollTop;return this.clearScroll(),this.$nextTick().then(function(){if(e||i)return t.lastScrollLeft=0,t.lastScrollTop=0,t.scrollTo(e,i)})},scrollTo:function(t,e){var i=this,s=this.$refs.virtualWrapper;return _xeUtils.default.isNumber(t)&&(s.scrollLeft=t),_xeUtils.default.isNumber(e)&&(s.scrollTop=e),_tools.DomTools.triggerEvent(s,"scroll"),this.scrollYLoad?new Promise(function(t){return setTimeout(function(){return t(i.$nextTick())},50)}):this.$nextTick()},computeScrollLoad:function(){var o=this;return this.$nextTick().then(function(){var t=o.$refs,e=o.sYOpts,i=o.scrollYLoad,s=o.scrollYStore;if(i){var l,r=48;if(e.rHeight)r=e.rHeight;else e.sItem&&(l=t.body.querySelector(e.sItem)),l||(l=t.body.children[0]),l&&(r=l.offsetHeight);var a=_xeUtils.default.toNumber(e.vSize||Math.ceil(t.virtualWrapper.clientHeight/r));s.visibleSize=a,s.rowHeight=r,e.oSize||(s.offsetSize=a),e.rSize||(s.renderSize=Math.max(6,a+2)),o.updateYData()}else o.updateYSpace()})},scrollEvent:function(t){var e=t.target,i=e.scrollTop,s=e.scrollLeft,l=s!==this.lastScrollLeft,r=i!==this.lastScrollTop;this.lastScrollTop=i,this.lastScrollLeft=s,this.scrollYLoad&&this.loadYData(t),this.$emit("scroll",{scrollLeft:s,scrollTop:i,isX:l,isY:r,$event:t})},loadYData:function(t){var e=this.fullData,i=this.scrollYStore,s=this.isLoadData,l=i.startIndex,r=i.renderSize,a=i.offsetSize,o=i.visibleSize,n=i.rowHeight,c=t.target.scrollTop,h=Math.ceil(c/n),u=!1;if(s||i.visibleIndex!==h){var d=Math.min(Math.floor((r-o)/2),o);i.visibleIndex>h?(u=h-a<=l)&&(i.startIndex=Math.max(0,h-Math.max(d,r-o))):(u=l+r<=h+o+a)&&(i.startIndex=Math.max(0,Math.min(e.length-r,h-d))),u&&this.updateYData(),i.visibleIndex=h,this.isLoadData=!1}},updateYData:function(){this.handleData(),this.updateYSpace()},updateYSpace:function(){var t=this.scrollYStore,e=this.scrollYLoad,i=this.fullData;this.bodyHeight=e?i.length*t.rowHeight:0,this.topSpaceHeight=e?Math.max(t.startIndex*t.rowHeight,0):0},handleGlobalResizeEvent:function(){this.recalculate()}}};exports.default=_default;