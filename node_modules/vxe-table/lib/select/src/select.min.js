"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.renderOption=renderOption,exports.renderOptgroup=renderOptgroup,exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_input=_interopRequireDefault(require("../../input/src/input")),_conf=_interopRequireDefault(require("../../conf")),_util=require("./util"),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function findOffsetOption(e,t,i){for(var n,o,l=!1,s=0;s<e.length;s++){var a=e[s];if(a.options)for(var r=0;r<a.options.length;r++){var p=a.options[r];if(o||(o=p),i){if(t===p.value)return{offsetOption:n,firstOption:o}}else{if(l)return{offsetOption:p,firstOption:o};t===p.value&&(l=!0)}n=p}else{if(o||(o=a),i){if(t===a.value)return{offsetOption:n,firstOption:o}}else{if(l)return{offsetOption:a,firstOption:o};t===a.value&&(l=!0)}n=a}}return{firstOption:o}}function findOption(e,t){for(var i=0;i<e.length;i++){var n=e[i];if(n.options)for(var o=0;o<n.options.length;o++){var l=n.options[o];if(t===l.value)return l}else if(t===n.value)return n}}function getSelectLabel(e,t){var i=findOption(e,t);return _xeUtils.default.toString(i?i.label:t)}function renderOption(l,s,e,a){var r=s.optkey,p=s.value,u=s.multiple,d=s.currentValue,t=s.optionGroupProps,i=void 0===t?{}:t,n=s.optionProps,o=void 0===n?{}:n,f=i.disabled||"disabled",h=o.label||"label",c=o.value||"value",v=o.disabled||"disabled";return e?e.map(function(e,t){var i=a&&a[f]||e[v],n=e[c],o=(0,_util.getOptid)(s,e);return l("div",{key:r?o:t,class:["vxe-select-option",{"is--disabled":i,"is--selected":u?p&&-1<p.indexOf(n):p===n,"is--hover":d===n}],attrs:{"data-optid":o},on:{click:function(e){i||s.changeOptionEvent(e,n)},mouseenter:function(){i||s.setCurrentOption({value:n})}}},_tools.UtilTools.formatText(_tools.UtilTools.getFuncText(e[h])))}):[]}function renderOptgroup(n,o){var l=o.optkey,e=o.optionGroups,t=o.optionGroupProps,i=void 0===t?{}:t,s=i.options||"options",a=i.label||"label",r=i.disabled||"disabled";return e?e.map(function(e,t){var i=(0,_util.getOptid)(o,e);return n("div",{key:l?i:t,class:["vxe-optgroup",{"is--disabled":e[r]}],attrs:{"data-optid":i}},[n("div",{class:"vxe-optgroup--title"},_tools.UtilTools.getFuncText(e[a])),n("div",{class:"vxe-optgroup--wrapper"},renderOption(n,o,e[s],e))])}):[]}var _default2={name:"VxeSelect",props:{value:null,clearable:Boolean,placeholder:String,disabled:Boolean,multiple:Boolean,prefixIcon:String,placement:String,options:Array,optionProps:Object,optionGroups:Array,optionGroupProps:Object,size:{type:String,default:function(){return _conf.default.select.size||_conf.default.size}},optId:{type:String,default:function(){return _conf.default.select.optId}},optKey:Boolean,transfer:{type:Boolean,default:function(){return _conf.default.select.transfer}}},components:{VxeInput:_input.default},provide:function(){return{$xeselect:this}},data:function(){return{updateFlag:0,panelIndex:0,optionList:[],allOptList:[],panelStyle:null,panelPlacement:null,currentValue:null,visiblePanel:!1,animatVisible:!1,isActivated:!1}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},selectLabel:function(){var e=this.value,t=this.multiple,i=this.allOptList;return e&&t?e.map(function(e){var t=getSelectLabel(i,e);return 8<t.length?"".concat(t.substring(0,8),"..."):t}).join(", "):getSelectLabel(i,e)}},watch:{options:function(){this.updateCache(),this.updateOptComps()},optionGroups:function(){this.updateCache(),this.updateOptComps()},updateFlag:function(){this.updateOptComps()}},created:function(){(this.options||this.optionGroups)&&(this.updateCache(),this.updateOptComps()),_tools.GlobalEvent.on(this,"mousewheel",this.handleGlobalMousewheelEvent),_tools.GlobalEvent.on(this,"mousedown",this.handleGlobalMousedownEvent),_tools.GlobalEvent.on(this,"keydown",this.handleGlobalKeydownEvent),_tools.GlobalEvent.on(this,"blur",this.handleGlobalBlurEvent)},mounted:function(){this.transfer&&document.body.appendChild(this.$refs.panel)},beforeDestroy:function(){var e=this.$refs.panel;e&&e.parentNode&&e.parentNode.removeChild(e)},destroyed:function(){_tools.GlobalEvent.off(this,"mousewheel"),_tools.GlobalEvent.off(this,"mousedown"),_tools.GlobalEvent.off(this,"keydown"),_tools.GlobalEvent.off(this,"blur")},render:function(e){var t,i,n=this.vSize,o=this.transfer,l=this.isActivated,s=this.disabled,a=this.clearable,r=this.placeholder,p=this.selectLabel,u=this.animatVisible,d=this.visiblePanel,f=this.panelStyle,h=this.prefixIcon,c=this.panelPlacement,v=this.optionGroups;return e("div",{class:["vxe-select",(t={},_defineProperty(t,"size--".concat(n),n),_defineProperty(t,"is--visivle",d),_defineProperty(t,"is--disabled",s),_defineProperty(t,"is--active",l),t)]},[e("vxe-input",{ref:"input",props:{clearable:a,placeholder:r,readonly:!0,disabled:s,type:"text",prefixIcon:h,suffixIcon:d?_conf.default.icon.SELECT_OPEN:_conf.default.icon.SELECT_CLOSE,value:p},on:{clear:this.clearEvent,click:this.togglePanelEvent,focus:this.focusEvent,blur:this.blurEvent,"suffix-click":this.togglePanelEvent}}),e("div",{ref:"panel",class:["vxe-table--ignore-clear vxe-select--panel",(i={},_defineProperty(i,"size--".concat(n),n),_defineProperty(i,"is--transfer",o),_defineProperty(i,"animat--leave",u),_defineProperty(i,"animat--enter",d),i)],attrs:{"data-placement":c},style:f},[e("div",{ref:"optWrapper",class:"vxe-select-option--wrapper"},this.$slots.default||(v?renderOptgroup(e,this):renderOption(e,this,this.options)))])])},methods:{updateOptions:function(){this.updateFlag++},updateCache:function(){var t=this,e=this.options,i=this.optionGroups,n=this.optionGroupProps,o=(void 0===n?{}:n).options||"options";if(i||e){var l=(0,_util.getOptkey)(this),s=function(e){(0,_util.getOptid)(t,e)||(e[l]=(0,_util.getOptUniqueId)())};i?i.forEach(function(e){s(e),e[o]&&e[o].forEach(s)}):e.forEach(s)}},updateOptComps:function(){var s=this,e=this.options,t=this.optionGroups,a=[],r=[];if(t||e){var i=this.optionProps,n=void 0===i?{}:i,o=this.optionGroupProps,l=void 0===o?{}:o,p=n.disabled||"disabled",u=n.label||"label",d=n.value||"value";if(t){var f=l.options||"options",h=l.label||"label",c=l.disabled||"disabled";t.forEach(function(n){var o=[],l=[];n[f].forEach(function(e){var t=n&&n[c]||e[p],i={label:e[u],value:e[d],disabled:t,id:(0,_util.getOptid)(s,e)};t||o.push(i),l.push(i)}),o.length&&a.push({label:n[h],disabled:n[c],options:o,id:(0,_util.getOptid)(s,n)}),l.length&&r.push({label:n[h],disabled:n[c],options:l,id:(0,_util.getOptid)(s,n)})})}else e.forEach(function(e){var t=e[p],i={label:e[u],value:e[d],disabled:t,id:(0,_util.getOptid)(s,e)};t||a.push(i),r.push(i)});return this.optionList=a,this.allOptList=r,Promise.resolve()}return this.$nextTick().then(function(){s.$children.forEach(function(e){if(e.$xeselect){var i=[],n=[],t=e.$children.length;if(e.$children.forEach(function(e){if(e.$xeselect&&e.$xeoptgroup){var t={label:e.label,value:e.value,disabled:e.isDisabled,id:e.id};e.isDisabled||i.push(t),n.push(t)}}),t)i.length&&a.push({label:e.label,disabled:e.disabled,options:i,id:e.id}),n.length&&r.push({label:e.label,disabled:e.disabled,options:n,id:e.id});else{var o={label:e.label,value:e.value,disabled:e.disabled,id:e.id};e.disabled||a.push(o),r.push(o)}}}),s.optionList=a,s.allOptList=r})},setCurrentOption:function(e){e&&(this.currentValue=e.value)},scrollToOption:function(l,s){var a=this;return new Promise(function(o){if(l)return a.$nextTick().then(function(){var e=a.$refs,t=e.optWrapper,i=e.panel.querySelector("[data-optid='".concat(l.id,"']"));if(t&&i){var n=t.offsetHeight;s?i.offsetTop+i.offsetHeight-t.scrollTop>n&&(t.scrollTop=i.offsetTop+i.offsetHeight-n):(i.offsetTop+5<t.scrollTop||i.offsetTop+5>t.scrollTop+t.clientHeight)&&(t.scrollTop=i.offsetTop-5)}o()});o()})},clearEvent:function(e,t){this.clearValueEvent(t,null),this.hideOptionPanel()},clearValueEvent:function(e,t){this.changeEvent(e,t),this.$emit("clear",{value:t,$event:e})},changeEvent:function(e,t){t!==this.value&&(this.$emit("input",t),this.$emit("change",{value:t,$event:e}))},changeOptionEvent:function(e,t){var i,n=this.value;this.multiple?(i=n?-1===n.indexOf(t)?n.concat([t]):n.filter(function(e){return e!==t}):[t],this.changeEvent(e,i)):(this.changeEvent(e,t),this.hideOptionPanel())},handleGlobalMousewheelEvent:function(e){var t=this.$refs,i=this.$el,n=this.disabled,o=this.visiblePanel;if(!n&&o){var l=_tools.DomTools.getEventTargetNode(e,i).flag;l||_tools.DomTools.getEventTargetNode(e,t.panel).flag?l&&this.updatePlacement():this.hideOptionPanel()}},handleGlobalMousedownEvent:function(e){var t=this.$refs,i=this.$el,n=this.disabled,o=this.visiblePanel;n||(this.isActivated=_tools.DomTools.getEventTargetNode(e,i).flag||_tools.DomTools.getEventTargetNode(e,t.panel).flag,o&&!this.isActivated&&this.hideOptionPanel())},handleGlobalKeydownEvent:function(e){var t=this.visiblePanel,i=this.currentValue,n=this.clearable;if(!this.disabled){var o=e.keyCode,l=9===o,s=13===o,a=27===o,r=38===o,p=40===o,u=46===o,d=32===o;if(l&&(this.isActivated=!1),t)if(a||l)this.hideOptionPanel();else if(s)this.changeOptionEvent(e,i);else if(r||p){e.preventDefault();var f=this.optionList,h=findOffsetOption(f,i,r),c=h.offsetOption,v=h.firstOption;c||findOption(f,i)||(c=v),this.setCurrentOption(c),this.scrollToOption(c,p)}else d&&e.preventDefault();else(r||p||s||d)&&this.isActivated&&(e.preventDefault(),this.showOptionPanel());this.isActivated&&u&&n&&this.clearValueEvent(e,null)}},handleGlobalBlurEvent:function(){this.hideOptionPanel()},updateZindex:function(){this.panelIndex<_tools.UtilTools.getLastZIndex()&&(this.panelIndex=_tools.UtilTools.nextZIndex())},focusEvent:function(){this.disabled||(this.isActivated=!0)},blurEvent:function(){this.isActivated=!1},togglePanelEvent:function(e){e.$event.preventDefault(),this.visiblePanel?this.hideOptionPanel():this.showOptionPanel()},showOptionPanel:function(){var n=this;this.disabled||(clearTimeout(this.hidePanelTimeout),this.isActivated=!0,this.animatVisible=!0,setTimeout(function(){var e=n.value,t=n.multiple,i=findOption(n.allOptList,t&&e?e[0]:e);n.visiblePanel=!0,i&&(n.setCurrentOption(i),n.scrollToOption(i))},10),this.updateZindex(),this.updatePlacement())},hideOptionPanel:function(){var e=this;this.visiblePanel=!1,this.hidePanelTimeout=setTimeout(function(){e.animatVisible=!1},350)},updatePlacement:function(){var m=this;return this.$nextTick().then(function(){var e=m.$refs,t=m.transfer,i=m.placement,n=m.panelIndex,o=e.input.$el,l=e.panel,s=o.offsetHeight,a=o.offsetWidth,r=l.offsetHeight,p=l.offsetWidth,u={zIndex:n},d=_tools.DomTools.getAbsolutePos(o),f=d.boundingTop,h=d.boundingLeft,c=d.visibleHeight,v=d.visibleWidth,b="bottom";if(t){var g=h,O=f+s;"top"===i?(b="top",O=f-r):(c<O+r+5&&(b="top",O=f-r),O<5&&(b="bottom",O=f+s)),v<g+p+5&&(g-=g+p+5-v),g<5&&(g=5),Object.assign(u,{left:"".concat(g,"px"),top:"".concat(O,"px"),minWidth:"".concat(a,"px")})}else"top"===i?(b="top",u.bottom="".concat(s,"px")):c<f+s+r&&(b="top",u.bottom="".concat(s,"px"));return m.panelStyle=u,m.panelPlacement=b,m.$nextTick()})},focus:function(){return this.showOptionPanel(),this.$nextTick()},blur:function(){return this.hideOptionPanel(),this.$nextTick()}}};exports.default=_default2;